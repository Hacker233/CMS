{"version":3,"file":"GenericProvider.js","sourceRoot":"","sources":["../src/GenericProvider.ts"],"names":[],"mappings":";;;;;;;AAAA,AAAO,AAAwB,AAAS,AAAE,AAAQ,AAAc,AAAM,AAAsB;;;;;;;;;;AAE5F,AAAO,AAAE,AAAkB,AAAE,AAAoB,AAAE,AAAqB,AAAE,AAAmB,AAAE,AAAU,AAAE,AAAc,AAAE,AAAQ,AAA0B,AAAM,AAAQ;;;;;;;;;;AAC3K,AAAO,AAAE,AAAe,AAAE,AAAY,AAAE,AAAM,AAAY,AAE1D,AAAM;;;;;;;;;;MAAuB,wBAAQ,AAAoB;AAGvD,cAA6B,AAAmC,eAAmB,AAAmB,SAAE,AAAuB,0BAAG,AAAI;AACpI,AAAK,UAAC,AAAO,QAAC,AAAY,cAAE,AAAuB,AAAC;AADzB,SAAa,gBAAb,AAAa,AAAsB;AAAmB,SAAO,UAAP,AAAO,AAAY;AAFrF,SAAO,UAAG,AAAU,wBAAC,AAAI,KAAC,AAAa,cAAC,AAAG,AAAC,AAI7D;AAAC;;AAED,MAAY,AAAO;AACjB,UAAM,AAAM,SAAG,AAAI,KAAC,AAAO,QAAC,AAAO,WAAI,AAAI,KAAC,AAAa,cAAC,AAAO;AACjE,WAAO,AAAM,UAAI,AAAI,AAAC,AAAC,OAAC,AAAqB,AAAE,AAAC,AAAC,uCAAC,AAAoB,kCAAC,AAAM,AAAC,AAChF;AAAC;;AAED,AAAK,QAAC,AAAgB;AACpB,QAAI,AAAkB;AACtB,UAAM,AAAW,cAAG,AAAkB,gCAAC,AAAI,KAAC,AAAO,AAAC;AACpD,UAAM,AAAU,aAAG,AAAc,4BAAC,AAAW,aAAE,AAAI,KAAC,AAAO,AAAC;;AAC5D,SAAK,IAAI,AAAa,gBAAG,AAAC,IAAI,AAAa,AAAE,iBAAE;AAC7C,UAAI;AACF,AAAM,iBAAG,AAAe,kCAAC,MAAM,AAAI,KAAC,AAAW,YAAC,AAAU,AAAC,cAAE,AAAW,aAAE,AAAU,AAAC;AACrF,AAAK;AACN,QACD,OAAO,AAAC,GAAE;AACR,YAAI,AAAC,aAAY,AAAS,mCAAI,AAAC,EAAC,AAAU,eAAK,AAAG,KAAE;AAClD,gBAAM,AAAQ,AAAC,4DAAwB,AAAW,6BAAkB,AAAC,EAAC,AAAK,SAAI,AAAC,EAAC,AAAO,OAAE,IAAE,AAAoC,AAAC;AAClI,eACI,IAAI,AAAC,EAAC,AAAI,SAAK,AAAc,gBAAE;AAClC,cAAI,AAAa,gBAAG,AAAC,GAAE;AACrB,sBAAU,AAAO,QAAC,CAAC,AAAO,SAAE,AAAM,AAAE,AAAE;AACpC,kBAAI;AACF,AAAU,2BAAC,AAAO,SAAE,AAAI,OAAG,AAAa,AAAC;AAC1C,gBACD,OAAO,AAAC,GAAE;AACR,AAAM,uBAAC,AAAC,AAAC;AACV,AACH;AAAC,AAAC,aAPI;AAQN,AAAQ;AACT;AACF;;AACD,cAAM,AAAC;AACR;AACF;;AAED,QAAI,AAAmB,AAAE,oCAAE;AACxB,AAAc,aAAC,AAAc,iBAAG,AAAU,WAAC,AAAI;AACjD;;AACD,WAAO,AAAM,AACf;AAAC;;AAED,AAAY,eAAC,AAAsB;AACjC,WAAO,AAAY,8BAAC,AAAU,YAAE,AAAI,KAAC,AAAO,AAAC,AAC/C;AAAC,AACF","sourcesContent":["import { GenericServerOptions, HttpError, newError, UpdateInfo } from \"builder-util-runtime\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { getChannelFilename, getCustomChannelName, getDefaultChannelName, isUseOldMacProvider, newBaseUrl, newUrlFromBase, Provider, ResolvedUpdateFileInfo } from \"./main\"\nimport { parseUpdateInfo, resolveFiles } from \"./Provider\"\n\nexport class GenericProvider extends Provider<UpdateInfo> {\n  private readonly baseUrl = newBaseUrl(this.configuration.url)\n\n  constructor(private readonly configuration: GenericServerOptions, private readonly updater: AppUpdater, useMultipleRangeRequest = true) {\n    super(updater.httpExecutor, useMultipleRangeRequest)\n  }\n\n  private get channel(): string {\n    const result = this.updater.channel || this.configuration.channel\n    return result == null ? getDefaultChannelName() : getCustomChannelName(result)\n  }\n\n  async getLatestVersion(): Promise<UpdateInfo> {\n    let result: UpdateInfo\n    const channelFile = getChannelFilename(this.channel)\n    const channelUrl = newUrlFromBase(channelFile, this.baseUrl)\n    for (let attemptNumber = 0; ; attemptNumber++) {\n      try {\n        result = parseUpdateInfo(await this.httpRequest(channelUrl), channelFile, channelUrl)\n        break\n      }\n      catch (e) {\n        if (e instanceof HttpError && e.statusCode === 404) {\n          throw newError(`Cannot find channel \"${channelFile}\" update info: ${e.stack || e.message}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n        }\n        else if (e.code === \"ECONNREFUSED\") {\n          if (attemptNumber < 3) {\n            await new Promise((resolve, reject) => {\n              try {\n                setTimeout(resolve, 1000 * attemptNumber)\n              }\n              catch (e) {\n                reject(e)\n              }\n            })\n            continue\n          }\n        }\n        throw e\n      }\n    }\n\n    if (isUseOldMacProvider()) {\n      (result as any).releaseJsonUrl = channelUrl.href\n    }\n    return result\n  }\n\n  resolveFiles(updateInfo: UpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return resolveFiles(updateInfo, this.baseUrl)\n  }\n}"]}
